-- 001_courses_lessons_sessions.sql
-- Курсы -> Уроки -> Занятия (секции)
-- Применять в Supabase SQL Editor.

-- 1) Курсы
create table if not exists public.courses (
  id bigserial primary key,
  title text not null,
  description text,
  image_url text,
  created_at timestamptz not null default now()
);

-- 2) Связь уроков с курсами (добавляем поле в существующую таблицу lessons)
alter table public.lessons
  add column if not exists course_id bigint;

alter table public.lessons
  add column if not exists order_index int not null default 0;

-- FK (если ещё не было)
do $$
begin
  if not exists (
    select 1
    from pg_constraint
    where conname = 'lessons_course_id_fkey'
  ) then
    alter table public.lessons
      add constraint lessons_course_id_fkey
      foreign key (course_id) references public.courses(id)
      on delete set null;
  end if;
end $$;

create index if not exists lessons_course_id_idx on public.lessons(course_id);

-- 3) Занятия (секции) внутри урока
create table if not exists public.lesson_sessions (
  id bigserial primary key,
  lesson_id bigint not null references public.lessons(id) on delete cascade,
  title text not null,
  content text,
  order_index int not null default 0,
  created_at timestamptz not null default now()
);

create index if not exists lesson_sessions_lesson_id_idx on public.lesson_sessions(lesson_id);

-- 4) Добавляем поле image_url если его ещё нет
alter table public.courses
  add column if not exists image_url text;

-- 5) Тестовые данные
-- Курсы
insert into public.courses (title, description, image_url) values
  ('Основы саморазвития', 'Пройдите базовый курс по саморазвитию и узнайте, как начать свой путь к личностному росту.', 'https://images.unsplash.com/photo-1501504905252-473c47e087f8?w=400&h=300&fit=crop'),
  ('Эффективное планирование', 'Научитесь правильно планировать своё время и достигать поставленных целей.', 'https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?w=400&h=300&fit=crop'),
  ('Развитие навыков общения', 'Улучшите свои коммуникативные навыки и научитесь эффективно взаимодействовать с людьми.', 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=400&h=300&fit=crop')
on conflict do nothing;

-- Уроки (привязываем к первому курсу)
insert into public.lessons (title, course_id, order_index) values
  ('Введение в саморазвитие', 1, 1),
  ('Постановка целей', 1, 2),
  ('Формирование привычек', 1, 3),
  ('Основы тайм-менеджмента', 2, 1),
  ('Приоритизация задач', 2, 2),
  ('Эффективные техники планирования', 2, 3),
  ('Активное слушание', 3, 1),
  ('Невербальная коммуникация', 3, 2),
  ('Работа с возражениями', 3, 3)
on conflict do nothing;

-- Занятия для уроков
insert into public.lesson_sessions (lesson_id, title, content, order_index) values
  -- Занятия для урока "Введение в саморазвитие"
  (1, 'Что такое саморазвитие?', 'Саморазвитие — это процесс постоянного улучшения себя через обучение, практику и рефлексию. Это путь к лучшей версии себя.', 1),
  (1, 'Зачем нужно саморазвитие?', 'Саморазвитие помогает достигать целей, повышать качество жизни, развивать навыки и становиться более уверенным в себе.', 2),
  -- Занятия для урока "Постановка целей"
  (2, 'SMART-цели', 'SMART — это аббревиатура: Specific (конкретная), Measurable (измеримая), Achievable (достижимая), Relevant (релевантная), Time-bound (ограниченная по времени).', 1),
  (2, 'Долгосрочные и краткосрочные цели', 'Долгосрочные цели — это ваше видение на год и более. Краткосрочные цели — это шаги к достижению долгосрочных целей.', 2),
  -- Занятия для урока "Формирование привычек"
  (3, 'Как формируются привычки?', 'Привычки формируются через повторение действий. Важно начать с малого и постепенно увеличивать сложность.', 1),
  (3, 'Метод 21 дня', 'Считается, что для формирования привычки нужно 21 день постоянного повторения. Но на самом деле это может занять от 18 до 254 дней.', 2),
  -- Занятия для урока "Основы тайм-менеджмента"
  (4, 'Принцип Парето', '80% результатов дают 20% усилий. Определите эти 20% и сосредоточьтесь на них.', 1),
  (4, 'Матрица Эйзенхауэра', 'Разделите задачи на 4 категории: срочные и важные, важные но не срочные, срочные но не важные, не срочные и не важные.', 2),
  -- Занятия для урока "Приоритизация задач"
  (5, 'Метод ABC', 'Разделите задачи на категории: A — самые важные, B — важные, C — менее важные. Начните с категории A.', 1),
  -- Занятия для урока "Эффективные техники планирования"
  (6, 'Техника Pomodoro', 'Работайте 25 минут, затем делайте перерыв 5 минут. После 4 циклов — длинный перерыв 15-30 минут.', 1),
  (6, 'Блокировка времени', 'Выделяйте конкретные временные блоки для разных типов задач. Это помогает лучше контролировать время.', 2),
  -- Занятия для урока "Активное слушание"
  (7, 'Что такое активное слушание?', 'Активное слушание — это полное внимание к собеседнику, понимание его слов и эмоций, и соответствующая реакция.', 1),
  (7, 'Техники активного слушания', 'Используйте перефразирование, уточняющие вопросы, отражение эмоций и невербальные сигналы внимания.', 2),
  -- Занятия для урока "Невербальная коммуникация"
  (8, 'Язык тела', 'Язык тела передаёт до 55% информации. Обращайте внимание на позу, жесты, мимику и зрительный контакт.', 1),
  (8, 'Тон голоса', 'Тон голоса передаёт до 38% информации. Работайте над интонацией, темпом и громкостью речи.', 2),
  -- Занятия для урока "Работа с возражениями"
  (9, 'Типы возражений', 'Возражения могут быть логическими, эмоциональными или скрытыми. Важно определить тип и работать с ним соответственно.', 1),
  (9, 'Техника "Согласие и развитие"', 'Согласитесь с частью возражения, затем мягко развивайте тему в нужном направлении.', 2)
on conflict do nothing;

